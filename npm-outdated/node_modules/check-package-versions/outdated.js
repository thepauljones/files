#! /usr/local/bin/node

const exec = require('child_process').exec;
const pkg = require('./package.json');

const dependencies = pkg.dependencies;

function checkVersion(currentPackage, currentVersion) {
    return new Promise((resolve) => {
        exec(`npm show ${currentPackage} version`, (error, stdout) => {
            const latestVersion = stdout.replace('\n', '');
            if (currentVersion !== latestVersion) {
                resolve(`${currentPackage} ${currentVersion} -> ${stdout}`);
            } else {
                resolve('');
            }
        });
    });
}

const allChecks = [];
for (const installed of Object.keys(dependencies)) {
    const version = dependencies[installed].replace('^', '');
    allChecks.push(checkVersion(installed, version));
}

Promise.all(allChecks).then((result) => {
    let noneFound = true;
    result.forEach((item) => {
        if (item !== '') {
            noneFound = false;
            console.log(`${item}`);
        }
        if (noneFound) {
            console.log('No out of date packages were found');
        }
    });
});
